062623.Mantel_Tests.txt

## here we run mantel tests on all 4 fst tables generated by the Stacks populations run

## note that Stacks Populations outputs fst tables not as a square matrix and you will have to add a populaiton to the final row, whichis usually the last column.  for each cell where 2 same popoulations cross, you should add '0' values as well.

## for example,
	RMT	NTP	RBM	BBF	BBM	PKM	GFM	HRM	STM	TG	SCM
RMT		0.0589095	0.0624721	0.0892367	0.0697997	0.0591145	0.0669839	0.129996	0.11098	0.0896546	0.0554242
NTP			0.0596924	0.0857977	0.069645	0.0744793	0.0943251	0.157503	0.140751	0.0870783	0.0447817
RBM				0.093875	0.0890104	0.0848085	0.0988284	0.17781	0.17153	0.100087	0.078697
BBF					0.150852	0.122612	0.147528	0.263432	0.283306	0.156439	0.121839
BBM						0.0987686	0.11382	0.229184	0.265413	0.13895	0.0979718
PKM							0.080124	0.16354	0.163191	0.121688	0.0857077
GFM								0.15597	0.159285	0.138456	0.101606
HRM									0.256863	0.245614	0.187225
STM										0.258728	0.17466
TG											0.11348

## is coverted to, 

	RMT	NTP	RBM	BBF	BBM	PKM	GFM	HRM	STM	TG	SCM
RMT	0	0.0589095	0.0624721	0.0892367	0.0697997	0.0591145	0.0669839	0.129996	0.11098	0.0896546	0.0554242
NTP		0	0.0596924	0.0857977	0.069645	0.0744793	0.0943251	0.157503	0.140751	0.0870783	0.0447817
RBM			0	0.093875	0.0890104	0.0848085	0.0988284	0.17781	0.17153	0.100087	0.078697
BBF				0	0.150852	0.122612	0.147528	0.263432	0.283306	0.156439	0.121839
BBM					0	0.0987686	0.11382	0.229184	0.265413	0.13895	0.0979718
PKM						0	0.080124	0.16354	0.163191	0.121688	0.0857077
GFM							0	0.15597	0.159285	0.138456	0.101606
HRM								0	0.256863	0.245614	0.187225
STM									0	0.258728	0.17466
TG										0	0.11348
SCM											0





#########################
#
#####----- R Work
#
#########################


# Load required packages
library(ade4)
library(geosphere)


# List of Fst file names
fst_files <- c("msl8_70md_micpet-071921.p.fst_summary.tsv", "msl29_49md_micpet-071921.p.fst_summary.tsv", "msl35_45md_micpet-071921.p.fst_summary.tsv", "msl57_40md_micpet-071921.p.fst_summary.tsv")

# Iterate over each Fst file
for (file in fst_files) {
  # Read Fst table
  fst_table <- read.table(file, header = TRUE, row.names = 1, sep = "\t")
  fst_matrix <- as.matrix(fst_table)
  
  # Print the Fst table
  cat("Fst table:", file, "\n")
  print(fst_table)
  cat("\n")
  
  # Fill in missing values
  for (i in 1:nrow(fst_matrix)) {
    for (j in 1:ncol(fst_matrix)) {
      if (is.na(fst_matrix[i, j])) {
        fst_matrix[i, j] <- fst_table[j, i]
      }
    }
  }
  
  # Calculate geographical distances
  geo_dist <- distm(site_locations[, c("Longitude", "Latitude")], fun = distHaversine)
  geo_dist_matrix <- as.matrix(geo_dist)
  
  # Convert to distance matrices
  fst_dist_matrix <- as.dist(fst_matrix)
  geo_dist_dist_matrix <- as.dist(geo_dist_matrix)
  
  # Perform Mantel test
  library(ade4)
  mantel_fst_geodis <- mantel.randtest(fst_dist_matrix, geo_dist_dist_matrix, nrep = 9999)
  
  # Print results
  cat("Fst file:", file, "\n")
  print(mantel_fst_geodis)
  cat("\n")
}





## the results, 

Fst table: msl8_70md_micpet-071921.p.fst_summary.tsv 
    RMT      NTP      RBM      BBF      BBM      PKM      GFM      HRM      STM       TG      SCM
RMT   0 0.159692 0.188168 0.217554 0.204693 0.188320 0.184286 0.262285 0.306999 0.232321 0.200707
NTP  NA 0.000000 0.163435 0.186786 0.199245 0.190819 0.202729 0.261783 0.304027 0.214406 0.150778
RBM  NA       NA 0.000000 0.201946 0.199665 0.200679 0.199113 0.281811 0.294816 0.213610 0.189411
BBF  NA       NA       NA 0.000000 0.269264 0.221336 0.228546 0.361705 0.371751 0.281507 0.230222
BBM  NA       NA       NA       NA 0.000000 0.224671 0.225393 0.349507 0.496730 0.284487 0.273689
PKM  NA       NA       NA       NA       NA 0.000000 0.168522 0.278485 0.289160 0.253728 0.211033
GFM  NA       NA       NA       NA       NA       NA 0.000000 0.273071 0.323301 0.259669 0.205768
HRM  NA       NA       NA       NA       NA       NA       NA 0.000000 0.353702 0.368023 0.300398
STM  NA       NA       NA       NA       NA       NA       NA       NA 0.000000 0.484215 0.300157
TG   NA       NA       NA       NA       NA       NA       NA       NA       NA 0.000000 0.285616
SCM  NA       NA       NA       NA       NA       NA       NA       NA       NA       NA 0.000000

Fst file: msl8_70md_micpet-071921.p.fst_summary.tsv 
Monte-Carlo test
Call: mantel.randtest(m1 = fst_dist_matrix, m2 = geo_dist_dist_matrix, 
    nrepet = 9999)

Observation: 0.5494373 

Based on 9999 replicates
Simulated p-value: 0.0031 
Alternative hypothesis: greater 

    Std.Obs Expectation    Variance 
 2.86340857  0.00251194  0.03648291 

Fst table: msl29_49md_micpet-071921.p.fst_summary.tsv 
    RMT       NTP       RBM      BBF      BBM       PKM       GFM      HRM      STM       TG       SCM
RMT   0 0.0981893 0.1019070 0.135331 0.109744 0.0922028 0.0921519 0.175160 0.144089 0.133221 0.0997090
NTP  NA 0.0000000 0.0870667 0.113485 0.103289 0.1060340 0.1155480 0.196080 0.170134 0.116644 0.0768229
RBM  NA        NA 0.0000000 0.131251 0.125013 0.1156920 0.1203750 0.218163 0.206928 0.133733 0.1210010
BBF  NA        NA        NA 0.000000 0.184420 0.1568550 0.1647420 0.299227 0.312796 0.189279 0.1686450
BBM  NA        NA        NA       NA 0.000000 0.1300150 0.1341440 0.285506 0.306355 0.178893 0.1550190
PKM  NA        NA        NA       NA       NA 0.0000000 0.1014570 0.197482 0.194398 0.157373 0.1340340
GFM  NA        NA        NA       NA       NA        NA 0.0000000 0.195435 0.180169 0.163441 0.1311410
HRM  NA        NA        NA       NA       NA        NA        NA 0.000000 0.305464 0.296302 0.2507780
STM  NA        NA        NA       NA       NA        NA        NA       NA 0.000000 0.303235 0.2230680
TG   NA        NA        NA       NA       NA        NA        NA       NA       NA 0.000000 0.1679330
SCM  NA        NA        NA       NA       NA        NA        NA       NA       NA       NA 0.0000000

Fst file: msl29_49md_micpet-071921.p.fst_summary.tsv 
Monte-Carlo test
Call: mantel.randtest(m1 = fst_dist_matrix, m2 = geo_dist_dist_matrix, 
    nrepet = 9999)

Observation: 0.6324467 

Based on 9999 replicates
Simulated p-value: 2e-04 
Alternative hypothesis: greater 

     Std.Obs  Expectation     Variance 
 3.247358196 -0.003352546  0.038333600 

Fst table: msl35_45md_micpet-071921.p.fst_summary.tsv 
    RMT       NTP       RBM      BBF       BBM       PKM       GFM      HRM      STM       TG       SCM
RMT   0 0.0877206 0.0871837 0.120994 0.0931933 0.0825367 0.0804877 0.159624 0.133928 0.120127 0.0843569
NTP  NA 0.0000000 0.0778087 0.107048 0.0936572 0.0995114 0.1082440 0.186133 0.160176 0.110289 0.0685423
RBM  NA        NA 0.0000000 0.121372 0.1138400 0.1089780 0.1124010 0.208542 0.200478 0.123976 0.1103930
BBF  NA        NA        NA 0.000000 0.1746780 0.1482220 0.1559610 0.288215 0.299374 0.180619 0.1582740
BBM  NA        NA        NA       NA 0.0000000 0.1186050 0.1236150 0.273229 0.293306 0.167854 0.1397040
PKM  NA        NA        NA       NA        NA 0.0000000 0.0935510 0.186404 0.188469 0.148252 0.1215460
GFM  NA        NA        NA       NA        NA        NA 0.0000000 0.182688 0.176036 0.154167 0.1195990
HRM  NA        NA        NA       NA        NA        NA        NA 0.000000 0.292750 0.285439 0.2382950
STM  NA        NA        NA       NA        NA        NA        NA       NA 0.000000 0.287161 0.2108110
TG   NA        NA        NA       NA        NA        NA        NA       NA       NA 0.000000 0.1566970
SCM  NA        NA        NA       NA        NA        NA        NA       NA       NA       NA 0.0000000

Fst file: msl35_45md_micpet-071921.p.fst_summary.tsv 
Monte-Carlo test
Call: mantel.randtest(m1 = fst_dist_matrix, m2 = geo_dist_dist_matrix, 
    nrepet = 9999)

Observation: 0.6286648 

Based on 9999 replicates
Simulated p-value: 2e-04 
Alternative hypothesis: greater 

    Std.Obs Expectation    Variance 
 3.26923788 -0.00244473  0.03726632 

Fst table: msl57_40md_micpet-071921.p.fst_summary.tsv 
    RMT       NTP       RBM       BBF       BBM       PKM       GFM      HRM      STM        TG       SCM
RMT   0 0.0589095 0.0624721 0.0892367 0.0697997 0.0591145 0.0669839 0.129996 0.110980 0.0896546 0.0554242
NTP  NA 0.0000000 0.0596924 0.0857977 0.0696450 0.0744793 0.0943251 0.157503 0.140751 0.0870783 0.0447817
RBM  NA        NA 0.0000000 0.0938750 0.0890104 0.0848085 0.0988284 0.177810 0.171530 0.1000870 0.0786970
BBF  NA        NA        NA 0.0000000 0.1508520 0.1226120 0.1475280 0.263432 0.283306 0.1564390 0.1218390
BBM  NA        NA        NA        NA 0.0000000 0.0987686 0.1138200 0.229184 0.265413 0.1389500 0.0979718
PKM  NA        NA        NA        NA        NA 0.0000000 0.0801240 0.163540 0.163191 0.1216880 0.0857077
GFM  NA        NA        NA        NA        NA        NA 0.0000000 0.155970 0.159285 0.1384560 0.1016060
HRM  NA        NA        NA        NA        NA        NA        NA 0.000000 0.256863 0.2456140 0.1872250
STM  NA        NA        NA        NA        NA        NA        NA       NA 0.000000 0.2587280 0.1746600
TG   NA        NA        NA        NA        NA        NA        NA       NA       NA 0.0000000 0.1134800
SCM  NA        NA        NA        NA        NA        NA        NA       NA       NA        NA 0.0000000

Fst file: msl57_40md_micpet-071921.p.fst_summary.tsv 
Monte-Carlo test
Call: mantel.randtest(m1 = fst_dist_matrix, m2 = geo_dist_dist_matrix, 
    nrepet = 9999)

Observation: 0.6272232 

Based on 9999 replicates
Simulated p-value: 2e-04 
Alternative hypothesis: greater 

     Std.Obs  Expectation     Variance 
3.2267834554 0.0005001066 0.0377234849 



#####----- final table mantel test results for all fst tables

Table	Observation	P-Value 	

msl8_70md_micpet-071921.p.fst_summary.tsv	0.5494373	0.0031 	
msl29_49md_micpet-071921.p.fst_summary.tsv	0.6324467	2e-04  	
msl35_45md_micpet-071921.p.fst_summary.tsv	0.6286648	2e-04  	
msl57_40md_micpet-071921.p.fst_summary.tsv	0.6272232	2e-04  	





########################
#
#####----- Explanation of the Mantel test
#
########################


# The Mantel test is a statistical procedure used to assess the correlation between two distance matrices. It is commonly applied in various fields, including ecology, genetics, and geography. Here is a step-by-step explanation of how the Mantel test is performed and the results derived:

# Input: The test requires two distance matrices. Let's call them "Matrix 1" and "Matrix 2." These matrices quantify the dissimilarity or distance between pairs of objects or samples. For example, in genetic studies, they may represent genetic distances or dissimilarities between populations.

# Null Hypothesis: The Mantel test evaluates the null hypothesis that there is no correlation between the two distance matrices. The alternative hypothesis assumes a correlation between the matrices.

# Permutation: To assess the significance of the correlation, the Mantel test uses a permutation procedure. It randomly shuffles the rows and columns of one distance matrix while keeping the other fixed. This permutation step is repeated many times (e.g., 9999 iterations) to create a null distribution of correlations.

# Correlation Calculation: For each permutation, the correlation coefficient (e.g., Pearson's correlation) is computed between the permuted distance matrix and the fixed distance matrix. The correlation coefficient measures the strength and direction of the relationship between the matrices.

# Observation: The correlation coefficient is calculated between the original (unpermuted) distance matrices. This is the observed correlation.

# Simulated P-Value: The observed correlation is compared to the null distribution of correlations obtained from the permutations. The proportion of permuted correlations greater than or equal to the observed correlation provides the simulated p-value. A smaller p-value indicates a stronger evidence against the null hypothesis.

# Interpretation: If the simulated p-value is below a predetermined significance level (e.g., 0.05), the null hypothesis is rejected, suggesting a significant correlation between the two distance matrices. Otherwise, if the p-value is above the significance level, the null hypothesis cannot be rejected, and there is insufficient evidence to conclude a correlation.

# Here is a table summarizing the results derived from the Mantel test:

Table	Observation	Simulated P-Value
msl8_70md_micpet-071921.p.fst_summary.tsv	0.5494373	0.0031
msl29_49md_micpet-071921.p.fst_summary.tsv	0.6324467	2e-04
msl35_45md_micpet-071921.p.fst_summary.tsv	0.6286648	2e-04
msl57_40md_micpet-071921.p.fst_summary.tsv	0.6272232	2e-04

# In the above table, the "Observation" column represents the observed correlation coefficient between the two distance matrices. The "Simulated P-Value" column indicates the p-value obtained from the permutation procedure, indicating the significance level of the observed correlation.



## In the context of population genomics, the significant positive correlation observed between the distance matrices in the FST tables indicates a relationship between genetic differentiation and geographic distance or other factors taken into account. This finding has several implications:

# Population Structure: The positive correlation suggests that genetic differentiation among populations is influenced by geographical factors or other factors considered in the analysis. It implies that populations that are geographically closer or share similar environmental conditions are more likely to exhibit genetic similarities.

# Gene Flow: The observed correlation implies that there may be limited gene flow or genetic exchange between populations that are geographically distant or differ in environmental conditions. Genetic differentiation between such populations suggests the presence of barriers, such as geographic barriers or differences in habitat, that restrict gene flow and contribute to genetic divergence.

# Isolation by Distance: The positive correlation is consistent with the concept of isolation by distance, which states that genetic differentiation tends to increase with geographic distance. It suggests that genetic drift and limited dispersal lead to genetic divergence among populations over space.

# Adaptation and Selection: The significant correlation between genetic differentiation and factors like geographic distance or environmental conditions may indicate the role of natural selection in shaping genetic variation. Populations facing different environmental pressures or habitats may undergo adaptive processes that result in genetic divergence.
