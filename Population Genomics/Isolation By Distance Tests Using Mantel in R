062623.Mantel_Tests.txt

## here we run mantel tests on all 4 fst tables generated by the Stacks for distance from each site, elevation, and topography



################
#
#####----- Explanation of the Mantel test
#
################





# The Mantel test is a statistical procedure used to assess the correlation between two distance matrices. It is commonly applied in various fields, including ecology, genetics, and geography. Here is a step-by-step explanation of how the Mantel test is performed and the results derived:

# Input: The test requires two distance matrices. Let's call them "Matrix 1" and "Matrix 2." These matrices quantify the dissimilarity or distance between pairs of objects or samples. For example, in genetic studies, they may represent genetic distances or dissimilarities between populations.

# Null Hypothesis: The Mantel test evaluates the null hypothesis that there is no correlation between the two distance matrices. The alternative hypothesis assumes a correlation between the matrices.

# Permutation: To assess the significance of the correlation, the Mantel test uses a permutation procedure. It randomly shuffles the rows and columns of one distance matrix while keeping the other fixed. This permutation step is repeated many times (e.g., 9999 iterations) to create a null distribution of correlations.

# Correlation Calculation: For each permutation, the correlation coefficient (e.g., Pearson's correlation) is computed between the permuted distance matrix and the fixed distance matrix. The correlation coefficient measures the strength and direction of the relationship between the matrices.

# Observation: The correlation coefficient is calculated between the original (unpermuted) distance matrices. This is the observed correlation.

# Simulated P-Value: The observed correlation is compared to the null distribution of correlations obtained from the permutations. The proportion of permuted correlations greater than or equal to the observed correlation provides the simulated p-value. A smaller p-value indicates a stronger evidence against the null hypothesis.

# Interpretation: If the simulated p-value is below a predetermined significance level (e.g., 0.05), the null hypothesis is rejected, suggesting a significant correlation between the two distance matrices. Otherwise, if the p-value is above the significance level, the null hypothesis cannot be rejected, and there is insufficient evidence to conclude a correlation.





########################
#
#####----- Fst table transformations for R use
#
########################


## note that Stacks Populations outputs fst tables not as a square matrix and you will have to add a populaiton to the final row, whichis usually the last column.  for each cell where 2 same populations cross, you should add '0' values as well.

## for example,
	RMT	NTP	RBM	BBF	BBM	PKM	GFM	HRM	STM	TG	SCM
RMT		0.0589095	0.0624721	0.0892367	0.0697997	0.0591145	0.0669839	0.129996	0.11098	0.0896546	0.0554242
NTP			0.0596924	0.0857977	0.069645	0.0744793	0.0943251	0.157503	0.140751	0.0870783	0.0447817
RBM				0.093875	0.0890104	0.0848085	0.0988284	0.17781	0.17153	0.100087	0.078697
BBF					0.150852	0.122612	0.147528	0.263432	0.283306	0.156439	0.121839
BBM						0.0987686	0.11382	0.229184	0.265413	0.13895	0.0979718
PKM							0.080124	0.16354	0.163191	0.121688	0.0857077
GFM								0.15597	0.159285	0.138456	0.101606
HRM									0.256863	0.245614	0.187225
STM										0.258728	0.17466
TG											0.11348

## is manually coverted in Excel or other text editor as, 

	RMT	NTP	RBM	BBF	BBM	PKM	GFM	HRM	STM	TG	SCM
RMT	0	0.0589095	0.0624721	0.0892367	0.0697997	0.0591145	0.0669839	0.129996	0.11098	0.0896546	0.0554242
NTP		0	0.0596924	0.0857977	0.069645	0.0744793	0.0943251	0.157503	0.140751	0.0870783	0.0447817
RBM			0	0.093875	0.0890104	0.0848085	0.0988284	0.17781	0.17153	0.100087	0.078697
BBF				0	0.150852	0.122612	0.147528	0.263432	0.283306	0.156439	0.121839
BBM					0	0.0987686	0.11382	0.229184	0.265413	0.13895	0.0979718
PKM						0	0.080124	0.16354	0.163191	0.121688	0.0857077
GFM							0	0.15597	0.159285	0.138456	0.101606
HRM								0	0.256863	0.245614	0.187225
STM									0	0.258728	0.17466
TG										0	0.11348
SCM											0





#########################
#
#####----- R Work
#
#########################


# Load required packages
library(ade4)
library(geosphere)


## Set up loop for all fst files to make it faster for us 

# List of Fst file names
fst_files <- c("msl8_70md_micpet-071921.p.fst_summary.tsv", "msl29_49md_micpet-071921.p.fst_summary.tsv", "msl35_45md_micpet-071921.p.fst_summary.tsv", "msl57_40md_micpet-071921.p.fst_summary.tsv")

# Iterate over each Fst file
for (file in fst_files) {
  # Read Fst table
  fst_table <- read.table(file, header = TRUE, row.names = 1, sep = "\t")
  fst_matrix <- as.matrix(fst_table)
  
  # Print the Fst table
  cat("Fst table:", file, "\n")
  print(fst_table)
  cat("\n")
  
  # Fill in missing values
  for (i in 1:nrow(fst_matrix)) {
    for (j in 1:ncol(fst_matrix)) {
      if (is.na(fst_matrix[i, j])) {
        fst_matrix[i, j] <- fst_table[j, i]
      }
    }
  }
  




## Now we can run the mantel test for each parameter we are testing agians Fst.




#################################################
#
#  Isolation by distance test for Fst vs xy coordinates (distance)
#
#################################################





  # Calculate geographical distances
  geo_dist <- distm(site_locations[, c("Longitude", "Latitude")], fun = distHaversine)
  geo_dist_matrix <- as.matrix(geo_dist)
  
  # Convert to distance matrices
  fst_dist_matrix <- as.dist(fst_matrix)
  geo_dist_dist_matrix <- as.dist(geo_dist_matrix)
  
  # Perform Mantel test
  library(ade4)
  mantel_fst_geodis <- mantel.randtest(fst_dist_matrix, geo_dist_dist_matrix, nrep = 9999)
  
  # Print results
  cat("Fst file:", file, "\n")
  print(mantel_fst_geodis)
  cat("\n")
}


## the results, 

Fst table: msl8_70md_micpet-071921.p.fst_summary.tsv 
    RMT      NTP      RBM      BBF      BBM      PKM      GFM      HRM      STM       TG      SCM
RMT   0 0.159692 0.188168 0.217554 0.204693 0.188320 0.184286 0.262285 0.306999 0.232321 0.200707
NTP  NA 0.000000 0.163435 0.186786 0.199245 0.190819 0.202729 0.261783 0.304027 0.214406 0.150778
RBM  NA       NA 0.000000 0.201946 0.199665 0.200679 0.199113 0.281811 0.294816 0.213610 0.189411
BBF  NA       NA       NA 0.000000 0.269264 0.221336 0.228546 0.361705 0.371751 0.281507 0.230222
BBM  NA       NA       NA       NA 0.000000 0.224671 0.225393 0.349507 0.496730 0.284487 0.273689
PKM  NA       NA       NA       NA       NA 0.000000 0.168522 0.278485 0.289160 0.253728 0.211033
GFM  NA       NA       NA       NA       NA       NA 0.000000 0.273071 0.323301 0.259669 0.205768
HRM  NA       NA       NA       NA       NA       NA       NA 0.000000 0.353702 0.368023 0.300398
STM  NA       NA       NA       NA       NA       NA       NA       NA 0.000000 0.484215 0.300157
TG   NA       NA       NA       NA       NA       NA       NA       NA       NA 0.000000 0.285616
SCM  NA       NA       NA       NA       NA       NA       NA       NA       NA       NA 0.000000

Fst file: msl8_70md_micpet-071921.p.fst_summary.tsv 
Monte-Carlo test
Call: mantel.randtest(m1 = fst_dist_matrix, m2 = geo_dist_dist_matrix, 
    nrepet = 9999)

Observation: 0.5494373 

Based on 9999 replicates
Simulated p-value: 0.0031 
Alternative hypothesis: greater 

    Std.Obs Expectation    Variance 
 2.86340857  0.00251194  0.03648291 

Fst table: msl29_49md_micpet-071921.p.fst_summary.tsv 
    RMT       NTP       RBM      BBF      BBM       PKM       GFM      HRM      STM       TG       SCM
RMT   0 0.0981893 0.1019070 0.135331 0.109744 0.0922028 0.0921519 0.175160 0.144089 0.133221 0.0997090
NTP  NA 0.0000000 0.0870667 0.113485 0.103289 0.1060340 0.1155480 0.196080 0.170134 0.116644 0.0768229
RBM  NA        NA 0.0000000 0.131251 0.125013 0.1156920 0.1203750 0.218163 0.206928 0.133733 0.1210010
BBF  NA        NA        NA 0.000000 0.184420 0.1568550 0.1647420 0.299227 0.312796 0.189279 0.1686450
BBM  NA        NA        NA       NA 0.000000 0.1300150 0.1341440 0.285506 0.306355 0.178893 0.1550190
PKM  NA        NA        NA       NA       NA 0.0000000 0.1014570 0.197482 0.194398 0.157373 0.1340340
GFM  NA        NA        NA       NA       NA        NA 0.0000000 0.195435 0.180169 0.163441 0.1311410
HRM  NA        NA        NA       NA       NA        NA        NA 0.000000 0.305464 0.296302 0.2507780
STM  NA        NA        NA       NA       NA        NA        NA       NA 0.000000 0.303235 0.2230680
TG   NA        NA        NA       NA       NA        NA        NA       NA       NA 0.000000 0.1679330
SCM  NA        NA        NA       NA       NA        NA        NA       NA       NA       NA 0.0000000

Fst file: msl29_49md_micpet-071921.p.fst_summary.tsv 
Monte-Carlo test
Call: mantel.randtest(m1 = fst_dist_matrix, m2 = geo_dist_dist_matrix, 
    nrepet = 9999)

Observation: 0.6324467 

Based on 9999 replicates
Simulated p-value: 2e-04 
Alternative hypothesis: greater 

     Std.Obs  Expectation     Variance 
 3.247358196 -0.003352546  0.038333600 

Fst table: msl35_45md_micpet-071921.p.fst_summary.tsv 
    RMT       NTP       RBM      BBF       BBM       PKM       GFM      HRM      STM       TG       SCM
RMT   0 0.0877206 0.0871837 0.120994 0.0931933 0.0825367 0.0804877 0.159624 0.133928 0.120127 0.0843569
NTP  NA 0.0000000 0.0778087 0.107048 0.0936572 0.0995114 0.1082440 0.186133 0.160176 0.110289 0.0685423
RBM  NA        NA 0.0000000 0.121372 0.1138400 0.1089780 0.1124010 0.208542 0.200478 0.123976 0.1103930
BBF  NA        NA        NA 0.000000 0.1746780 0.1482220 0.1559610 0.288215 0.299374 0.180619 0.1582740
BBM  NA        NA        NA       NA 0.0000000 0.1186050 0.1236150 0.273229 0.293306 0.167854 0.1397040
PKM  NA        NA        NA       NA        NA 0.0000000 0.0935510 0.186404 0.188469 0.148252 0.1215460
GFM  NA        NA        NA       NA        NA        NA 0.0000000 0.182688 0.176036 0.154167 0.1195990
HRM  NA        NA        NA       NA        NA        NA        NA 0.000000 0.292750 0.285439 0.2382950
STM  NA        NA        NA       NA        NA        NA        NA       NA 0.000000 0.287161 0.2108110
TG   NA        NA        NA       NA        NA        NA        NA       NA       NA 0.000000 0.1566970
SCM  NA        NA        NA       NA        NA        NA        NA       NA       NA       NA 0.0000000

Fst file: msl35_45md_micpet-071921.p.fst_summary.tsv 
Monte-Carlo test
Call: mantel.randtest(m1 = fst_dist_matrix, m2 = geo_dist_dist_matrix, 
    nrepet = 9999)

Observation: 0.6286648 

Based on 9999 replicates
Simulated p-value: 2e-04 
Alternative hypothesis: greater 

    Std.Obs Expectation    Variance 
 3.26923788 -0.00244473  0.03726632 

Fst table: msl57_40md_micpet-071921.p.fst_summary.tsv 
    RMT       NTP       RBM       BBF       BBM       PKM       GFM      HRM      STM        TG       SCM
RMT   0 0.0589095 0.0624721 0.0892367 0.0697997 0.0591145 0.0669839 0.129996 0.110980 0.0896546 0.0554242
NTP  NA 0.0000000 0.0596924 0.0857977 0.0696450 0.0744793 0.0943251 0.157503 0.140751 0.0870783 0.0447817
RBM  NA        NA 0.0000000 0.0938750 0.0890104 0.0848085 0.0988284 0.177810 0.171530 0.1000870 0.0786970
BBF  NA        NA        NA 0.0000000 0.1508520 0.1226120 0.1475280 0.263432 0.283306 0.1564390 0.1218390
BBM  NA        NA        NA        NA 0.0000000 0.0987686 0.1138200 0.229184 0.265413 0.1389500 0.0979718
PKM  NA        NA        NA        NA        NA 0.0000000 0.0801240 0.163540 0.163191 0.1216880 0.0857077
GFM  NA        NA        NA        NA        NA        NA 0.0000000 0.155970 0.159285 0.1384560 0.1016060
HRM  NA        NA        NA        NA        NA        NA        NA 0.000000 0.256863 0.2456140 0.1872250
STM  NA        NA        NA        NA        NA        NA        NA       NA 0.000000 0.2587280 0.1746600
TG   NA        NA        NA        NA        NA        NA        NA       NA       NA 0.0000000 0.1134800
SCM  NA        NA        NA        NA        NA        NA        NA       NA       NA        NA 0.0000000

Fst file: msl57_40md_micpet-071921.p.fst_summary.tsv 
Monte-Carlo test
Call: mantel.randtest(m1 = fst_dist_matrix, m2 = geo_dist_dist_matrix, 
    nrepet = 9999)

Observation: 0.6272232 

Based on 9999 replicates
Simulated p-value: 2e-04 
Alternative hypothesis: greater 

     Std.Obs  Expectation     Variance 
3.2267834554 0.0005001066 0.0377234849 


## final Fst vs Distance (site location) mantel test table

Table	Observation	P-Value 	

msl8_70md_micpet-071921.p.fst_summary.tsv	0.5494373	0.0031 	
msl29_49md_micpet-071921.p.fst_summary.tsv	0.6324467	2e-04  	
msl35_45md_micpet-071921.p.fst_summary.tsv	0.6286648	2e-04  	
msl57_40md_micpet-071921.p.fst_summary.tsv	0.6272232	2e-04  	





#################################################
#
#  Isolation by distance test for Fst vs elevation 
#
#################################################




fst_table1 <- read.table("msl8_70md_micpet-071921.p.fst_summary.tsv", header = TRUE, row.names = 1, sep = "\t")
fst_table2 <- read.table("msl29_49md_micpet-071921.p.fst_summary.tsv", header = TRUE, row.names = 1, sep = "\t")
fst_table3 <- read.table("msl35_45md_micpet-071921.p.fst_summary.tsv", header = TRUE, row.names = 1, sep = "\t")
fst_table4 <- read.table("msl57_40md_micpet-071921.p.fst_summary.tsv", header = TRUE, row.names = 1, sep = "\t")

fst_matrix1 <- as.matrix(fst_table1)
fst_matrix2 <- as.matrix(fst_table2)
fst_matrix3 <- as.matrix(fst_table3)
fst_matrix4 <- as.matrix(fst_table4)


 
# Replace missing values in fst_matrix1
for (i in 1:nrow(fst_matrix1)) {
    for (j in 1:ncol(fst_matrix1)) {
        if (is.na(fst_matrix1[i, j])) {
            fst_matrix1[i, j] <- fst_table1[j, i]
        }
    }
}
# Replace missing values in fst_matrix2
for (i in 1:nrow(fst_matrix2)) {
+     for (j in 1:ncol(fst_matrix2)) {
+         if (is.na(fst_matrix2[i, j])) {
+             fst_matrix2[i, j] <- fst_table2[j, i]
+         }
+     }
+ }

# Replace missing values in fst_matrix3
for (i in 1:nrow(fst_matrix3)) {
+     for (j in 1:ncol(fst_matrix3)) {
+         if (is.na(fst_matrix3[i, j])) {
+             fst_matrix3[i, j] <- fst_table3[j, i]
+         }
+     }
+ }

# Replace missing values in fst_matrix4
for (i in 1:nrow(fst_matrix4)) {
+     for (j in 1:ncol(fst_matrix4)) {
+         if (is.na(fst_matrix4[i, j])) {
+             fst_matrix4[i, j] <- fst_table4[j, i]
+         }
+     }
+ }
fst_matrix1
         RMT      NTP      RBM      BBF      BBM      PKM      GFM      HRM      STM       TG      SCM
RMT 0.000000 0.159692 0.188168 0.217554 0.204693 0.188320 0.184286 0.262285 0.306999 0.232321 0.200707
NTP 0.159692 0.000000 0.163435 0.186786 0.199245 0.190819 0.202729 0.261783 0.304027 0.214406 0.150778
RBM 0.188168 0.163435 0.000000 0.201946 0.199665 0.200679 0.199113 0.281811 0.294816 0.213610 0.189411
BBF 0.217554 0.186786 0.201946 0.000000 0.269264 0.221336 0.228546 0.361705 0.371751 0.281507 0.230222
BBM 0.204693 0.199245 0.199665 0.269264 0.000000 0.224671 0.225393 0.349507 0.496730 0.284487 0.273689
PKM 0.188320 0.190819 0.200679 0.221336 0.224671 0.000000 0.168522 0.278485 0.289160 0.253728 0.211033
GFM 0.184286 0.202729 0.199113 0.228546 0.225393 0.168522 0.000000 0.273071 0.323301 0.259669 0.205768
HRM 0.262285 0.261783 0.281811 0.361705 0.349507 0.278485 0.273071 0.000000 0.353702 0.368023 0.300398
STM 0.306999 0.304027 0.294816 0.371751 0.496730 0.289160 0.323301 0.353702 0.000000 0.484215 0.300157
TG  0.232321 0.214406 0.213610 0.281507 0.284487 0.253728 0.259669 0.368023 0.484215 0.000000 0.285616
SCM 0.200707 0.150778 0.189411 0.230222 0.273689 0.211033 0.205768 0.300398 0.300157 0.285616 0.000000
fst_matrix2
          RMT       NTP       RBM      BBF      BBM       PKM       GFM      HRM      STM       TG       SCM
RMT 0.0000000 0.0981893 0.1019070 0.135331 0.109744 0.0922028 0.0921519 0.175160 0.144089 0.133221 0.0997090
NTP 0.0981893 0.0000000 0.0870667 0.113485 0.103289 0.1060340 0.1155480 0.196080 0.170134 0.116644 0.0768229
RBM 0.1019070 0.0870667 0.0000000 0.131251 0.125013 0.1156920 0.1203750 0.218163 0.206928 0.133733 0.1210010
BBF 0.1353310 0.1134850 0.1312510 0.000000 0.184420 0.1568550 0.1647420 0.299227 0.312796 0.189279 0.1686450
BBM 0.1097440 0.1032890 0.1250130 0.184420 0.000000 0.1300150 0.1341440 0.285506 0.306355 0.178893 0.1550190
PKM 0.0922028 0.1060340 0.1156920 0.156855 0.130015 0.0000000 0.1014570 0.197482 0.194398 0.157373 0.1340340
GFM 0.0921519 0.1155480 0.1203750 0.164742 0.134144 0.1014570 0.0000000 0.195435 0.180169 0.163441 0.1311410
HRM 0.1751600 0.1960800 0.2181630 0.299227 0.285506 0.1974820 0.1954350 0.000000 0.305464 0.296302 0.2507780
STM 0.1440890 0.1701340 0.2069280 0.312796 0.306355 0.1943980 0.1801690 0.305464 0.000000 0.303235 0.2230680
TG  0.1332210 0.1166440 0.1337330 0.189279 0.178893 0.1573730 0.1634410 0.296302 0.303235 0.000000 0.1679330
SCM 0.0997090 0.0768229 0.1210010 0.168645 0.155019 0.1340340 0.1311410 0.250778 0.223068 0.167933 0.0000000
fst_matrix3
          RMT       NTP       RBM      BBF       BBM       PKM       GFM      HRM      STM       TG       SCM
RMT 0.0000000 0.0877206 0.0871837 0.120994 0.0931933 0.0825367 0.0804877 0.159624 0.133928 0.120127 0.0843569
NTP 0.0877206 0.0000000 0.0778087 0.107048 0.0936572 0.0995114 0.1082440 0.186133 0.160176 0.110289 0.0685423
RBM 0.0871837 0.0778087 0.0000000 0.121372 0.1138400 0.1089780 0.1124010 0.208542 0.200478 0.123976 0.1103930
BBF 0.1209940 0.1070480 0.1213720 0.000000 0.1746780 0.1482220 0.1559610 0.288215 0.299374 0.180619 0.1582740
BBM 0.0931933 0.0936572 0.1138400 0.174678 0.0000000 0.1186050 0.1236150 0.273229 0.293306 0.167854 0.1397040
PKM 0.0825367 0.0995114 0.1089780 0.148222 0.1186050 0.0000000 0.0935510 0.186404 0.188469 0.148252 0.1215460
GFM 0.0804877 0.1082440 0.1124010 0.155961 0.1236150 0.0935510 0.0000000 0.182688 0.176036 0.154167 0.1195990
HRM 0.1596240 0.1861330 0.2085420 0.288215 0.2732290 0.1864040 0.1826880 0.000000 0.292750 0.285439 0.2382950
STM 0.1339280 0.1601760 0.2004780 0.299374 0.2933060 0.1884690 0.1760360 0.292750 0.000000 0.287161 0.2108110
TG  0.1201270 0.1102890 0.1239760 0.180619 0.1678540 0.1482520 0.1541670 0.285439 0.287161 0.000000 0.1566970
SCM 0.0843569 0.0685423 0.1103930 0.158274 0.1397040 0.1215460 0.1195990 0.238295 0.210811 0.156697 0.0000000
fst_matrix4
          RMT       NTP       RBM       BBF       BBM       PKM       GFM      HRM      STM        TG       SCM
RMT 0.0000000 0.0589095 0.0624721 0.0892367 0.0697997 0.0591145 0.0669839 0.129996 0.110980 0.0896546 0.0554242
NTP 0.0589095 0.0000000 0.0596924 0.0857977 0.0696450 0.0744793 0.0943251 0.157503 0.140751 0.0870783 0.0447817
RBM 0.0624721 0.0596924 0.0000000 0.0938750 0.0890104 0.0848085 0.0988284 0.177810 0.171530 0.1000870 0.0786970
BBF 0.0892367 0.0857977 0.0938750 0.0000000 0.1508520 0.1226120 0.1475280 0.263432 0.283306 0.1564390 0.1218390
BBM 0.0697997 0.0696450 0.0890104 0.1508520 0.0000000 0.0987686 0.1138200 0.229184 0.265413 0.1389500 0.0979718
PKM 0.0591145 0.0744793 0.0848085 0.1226120 0.0987686 0.0000000 0.0801240 0.163540 0.163191 0.1216880 0.0857077
GFM 0.0669839 0.0943251 0.0988284 0.1475280 0.1138200 0.0801240 0.0000000 0.155970 0.159285 0.1384560 0.1016060
HRM 0.1299960 0.1575030 0.1778100 0.2634320 0.2291840 0.1635400 0.1559700 0.000000 0.256863 0.2456140 0.1872250
STM 0.1109800 0.1407510 0.1715300 0.2833060 0.2654130 0.1631910 0.1592850 0.256863 0.000000 0.2587280 0.1746600
TG  0.0896546 0.0870783 0.1000870 0.1564390 0.1389500 0.1216880 0.1384560 0.245614 0.258728 0.0000000 0.1134800
SCM 0.0554242 0.0447817 0.0786970 0.1218390 0.0979718 0.0857077 0.1016060 0.187225 0.174660 0.1134800 0.0000000

## transform to distance matrix
fst_dist_matrix1 <- as.dist(fst_matrix1)
fst_dist_matrix2 <- as.dist(fst_matrix2)
fst_dist_matrix3 <- as.dist(fst_matrix3)
fst_dist_matrix4 <- as.dist(fst_matrix4)


## now create a distance matrix of the elevation data

site_locations
   Site N_samples             Site_Name Latitude Longitude Elevation_Meters Elevation_Feet
1   RMT        16          Roan Mtn, NC 36.10474 -82.10390             1764       5787.684
2   NTP        11        Nine Times, SC 34.94474 -82.79566              372       1220.532
3   RBM        10        Rabun Bald, NC 34.96272 -83.29391             1131       3710.811
4   BBF         6    Big Bend Falls, SC 34.94234 -83.11648              620       2034.220
5   BBM         4 Black Balsalm Mtn, NC 35.32450 -82.87142             1741       5712.221
6   PKM         9       Potato Knob, NC 35.72623 -82.28911             1719       5640.039
7   GFM         9   Grandfather Mtn, NC 36.09980 -81.82645             1698       5571.138
8   HRM        10  Hanging Rock Mtn, NC 36.39659 -80.25517              559       1834.079
9   STM         5         Stone Mtn, NC 36.39012 -81.05083              524       1719.244
10   TG         8    Tallulah Gorge, GA 34.73597 -83.38980              448       1469.888
11  SCM         8         Scaly Mtn, NC 35.04286 -83.28329             1441       4727.921


## extract the elevation data
elevation_meters <- elevation_df$Meters
elevation_meters
 [1]  620 1741 1698  559  372 1719 1131 1764 1441  524  448

## create a matrix for the data
n <- length(elevation_meters)
pairwiseVertDistMatrix <- matrix(0, n, n)
pairwiseVertDistMatrix
      [,1] [,2] [,3] [,4] [,5] [,6] [,7] [,8] [,9] [,10] [,11]
 [1,]    0    0    0    0    0    0    0    0    0     0     0
 [2,]    0    0    0    0    0    0    0    0    0     0     0
 [3,]    0    0    0    0    0    0    0    0    0     0     0
 [4,]    0    0    0    0    0    0    0    0    0     0     0
 [5,]    0    0    0    0    0    0    0    0    0     0     0
 [6,]    0    0    0    0    0    0    0    0    0     0     0
 [7,]    0    0    0    0    0    0    0    0    0     0     0
 [8,]    0    0    0    0    0    0    0    0    0     0     0
 [9,]    0    0    0    0    0    0    0    0    0     0     0
[10,]    0    0    0    0    0    0    0    0    0     0     0
[11,]    0    0    0    0    0    0    0    0    0     0     0

## populate it with the elevation data

for (i in 1:n) {
+     for (j in 1:n) {
+         pairwiseVertDistMatrix[i, j] <- abs(elevation_meters[i] - elevation_meters[j])
+     }
+ }

pairwiseVertDistMatrix
      [,1] [,2] [,3] [,4] [,5] [,6] [,7] [,8] [,9] [,10] [,11]
 [1,]    0 1121 1078   61  248 1099  511 1144  821    96   172
 [2,] 1121    0   43 1182 1369   22  610   23  300  1217  1293
 [3,] 1078   43    0 1139 1326   21  567   66  257  1174  1250
 [4,]   61 1182 1139    0  187 1160  572 1205  882    35   111
 [5,]  248 1369 1326  187    0 1347  759 1392 1069   152    76
 [6,] 1099   22   21 1160 1347    0  588   45  278  1195  1271
 [7,]  511  610  567  572  759  588    0  633  310   607   683
 [8,] 1144   23   66 1205 1392   45  633    0  323  1240  1316
 [9,]  821  300  257  882 1069  278  310  323    0   917   993
[10,]   96 1217 1174   35  152 1195  607 1240  917     0    76
[11,]  172 1293 1250  111   76 1271  683 1316  993    76     0
pairwiseVertDistMatrix.dist <- as.dist(pairwiseVertDistMatrix)
pairwiseVertDistMatrix.dist
      1    2    3    4    5    6    7    8    9   10
2  1121                                             
3  1078   43                                        
4    61 1182 1139                                   
5   248 1369 1326  187                              
6  1099   22   21 1160 1347                         
7   511  610  567  572  759  588                    
8  1144   23   66 1205 1392   45  633               
9   821  300  257  882 1069  278  310  323          
10   96 1217 1174   35  152 1195  607 1240  917     
11  172 1293 1250  111   76 1271  683 1316  993   76


# Perform Mantel test for each FST file
mantel_fst_elev1 <- mantel.randtest(fst_dist_matrix1, pairwiseVertDistMatrix.dist, nrepet = 9999)
mantel_fst_elev2 <- mantel.randtest(fst_dist_matrix2, pairwiseVertDistMatrix.dist, nrepet = 9999)
mantel_fst_elev3 <- mantel.randtest(fst_dist_matrix3, pairwiseVertDistMatrix.dist, nrepet = 9999)
mantel_fst_elev4 <- mantel.randtest(fst_dist_matrix4, pairwiseVertDistMatrix.dist, nrepet = 9999)


## list each result
 
mantel_fst_elev1
Monte-Carlo test
Call: mantel.randtest(m1 = fst_dist_matrix1, m2 = pairwiseVertDistMatrix.dist, 
    nrepet = 9999)

Observation: 0.01387135 

Based on 9999 replicates
Simulated p-value: 0.4046 
Alternative hypothesis: greater 

     Std.Obs  Expectation     Variance 
0.1756170055 0.0001671898 0.0060893652 

mantel_fst_elev2
Monte-Carlo test
Call: mantel.randtest(m1 = fst_dist_matrix2, m2 = pairwiseVertDistMatrix.dist, 
    nrepet = 9999)

Observation: 0.06026285 

Based on 9999 replicates
Simulated p-value: 0.193 
Alternative hypothesis: greater 

     Std.Obs  Expectation     Variance 
0.8350532460 0.0003770057 0.0051430413 

mantel_fst_elev3
Monte-Carlo test
Call: mantel.randtest(m1 = fst_dist_matrix3, m2 = pairwiseVertDistMatrix.dist, 
    nrepet = 9999)

Observation: 0.05771401 

Based on 9999 replicates
Simulated p-value: 0.2075 
Alternative hypothesis: greater 

    Std.Obs Expectation    Variance 
0.790898816 0.001383798 0.005072720 

mantel_fst_elev4
Monte-Carlo test
Call: mantel.randtest(m1 = fst_dist_matrix4, m2 = pairwiseVertDistMatrix.dist, 
    nrepet = 9999)

Observation: 0.04956768 

Based on 9999 replicates
Simulated p-value: 0.2363 
Alternative hypothesis: greater 

     Std.Obs  Expectation     Variance 
0.6910840340 0.0004359596 0.0050543137 


## Final table 
+-------------------------------------+--------------+---------------+
|           FST File Name              | Observation  | Simulated p-value |
+-------------------------------------+--------------+---------------+
| msl8_70md_micpet-071921.p.fst_summary.tsv  |  0.01387135  |      0.4046     |
| msl29_49md_micpet-071921.p.fst_summary.tsv |  0.06026285  |      0.193      |
| msl35_45md_micpet-071921.p.fst_summary.tsv |  0.05771401  |      0.2075     |
| msl57_40md_micpet-071921.p.fst_summary.tsv |  0.04956768  |      0.2363     |
+-------------------------------------+--------------+---------------+


## Final FST vs elevation Matel Test Table

FST File Name                            Observation    Simulated p-value
msl8_70md_micpet-071921.p.fst_summary.tsv    0.01387135        0.4046
msl29_49md_micpet-071921.p.fst_summary.tsv   0.06026285        0.193
msl35_45md_micpet-071921.p.fst_summary.tsv   0.05771401        0.2075
msl57_40md_micpet-071921.p.fst_summary.tsv   0.04956768        0.2363














#################################################
#
#  Isolation by distance test for Fst vs topography 
#
#################################################




## Here we run a mantel test on the same Fst data but use topoDistance to create a matrix of the topographic paths between each site to test if topogrpahy plays a role in popualiton subdivisions (e.g., if ridges opr mountains prevent the flow of pollen and seeds)

## we will load the raster library and convert a clip from a DEM of the entire study area, clipped in ArcGIS Pro and saved as a tif, and then covert to an object so that the topoDistance package can analyze the "cost distance" between each point 


## load libraries

library(raster)
library(topoDistance)


## import the raster
SBRM_DEM<-"raster_clip.tif"
raster_data<-raster(SBRM_DEM)

## view raster data to check
raster_data

class      : RasterLayer 
dimensions : 1305, 2087, 2723535  (nrow, ncol, ncell)
resolution : 0.004166667, 0.004166667  (x, y)
extent     : -85.925, -77.22917, 32.73333, 38.17083  (xmin, xmax, ymin, ymax)
crs        : +proj=longlat +datum=WGS84 +no_defs 
source     : raster_clip.tif 
names      : METERS 
values     : -58, 1981  (min, max)
attributes :
         ID METERS
 from:  -58      0
  to : 1981      0

## import the site coordinates that are the same projection as the raster
site_coord_wgs1984<-read.table("site_coord_wgs1984", header=TRUE)

site_coord_wgs1984

     POINT_X  POINT_Y
1  -82.10369 36.10630
2  -82.79590 34.94528
3  -83.29215 34.96130
4  -83.11612 34.94207
5  -82.87166 35.32448
6  -82.28727 35.72649
7  -81.83663 36.09219
8  -80.25593 36.39623
9  -81.05038 36.38978
10 -83.39167 34.73876
11 -83.28336 35.03563
12 -82.57091 35.12506
13 -83.14064 35.07897

## plot both to double check
plot(raster_data)
plot(site_coord_wgs1984)

## calculate teh cost distance with topoDist
topoDist_df<-topoDist(raster_data, site_coord_wgs1984, paths = FALSE)

## view the dataframe
topoDist_df

           1         2          3         4         5         6         7         8         9        10         11
1       0.00 151811.83 169300.751 162328.44 112506.42  48120.76  24902.66 181537.53 109604.30 194376.20 164322.125
2  151811.83      0.00  46318.740  29035.15  44647.08 103744.19 159035.15 306251.56 234418.19  65190.80  49433.163
3  169300.75  46318.74      0.000  17307.82  57536.19 132296.62 192322.16 350370.04 278474.30  27852.51   8640.609
4  162328.44  29035.15  17307.818      0.00  50080.71 116983.77 176960.11 334891.07 263057.70  36232.39  20453.063
5  112506.42  44647.08  57536.194  50080.71      0.00  74808.05 134833.59 292890.60 220985.72  81947.53  52778.170
6   48120.76 103744.19 132296.624 116983.77  74808.05      0.00  60107.29 218183.96 146250.72 153131.17 127541.756
7   24902.66 159035.15 192322.165 176960.11 134833.59  60107.29      0.00 158109.87  86176.63 213156.71 187567.297
8  181537.53 306251.56 350370.037 334891.07 292890.60 218183.96 158109.87      0.00  71975.58 371115.79 345624.307
9  109604.30 234418.19 278474.299 263057.70 220985.72 146250.72  86176.63  71975.58      0.00 299282.42 273719.431
10 194376.20  65190.80  27852.506  36232.39  81947.53 153131.17 213156.71 371115.79 299282.42      0.00  36465.060
11 164322.12  49433.16   8640.609  20453.06  52778.17 127541.76 187567.30 345624.31 273719.43  36465.06      0.000
12 124176.37  30210.99  74648.483  59125.39  37734.37  76116.35 131268.43 276099.17 204265.80  95349.46  69938.411
13 149149.46  38266.23  20253.777  15690.71  37363.76 112082.97 172108.51 330152.58 258260.64  45892.08  15515.269
          12        13
1  124176.37 149149.46
2   30210.99  38266.23
3   74648.48  20253.78
4   59125.39  15690.71
5   37734.37  37363.76
6   76116.35 112082.97
7  131268.43 172108.51
8  276099.17 330152.58
9  204265.80 258260.64
10  95349.46  45892.08
11  69938.41  15515.27
12      0.00  54440.73
13  54440.73      0.00

## convert to dist class
topoDist_dist <- as.dist(topoDist_df)
topoDist_dist

            1          2          3          4          5          6          7          8          9         10
2  151811.832                                                                                                   
3  169300.751  46318.740                                                                                        
4  162328.438  29035.150  17307.818                                                                             
5  112506.421  44647.078  57536.194  50080.712                                                                  
6   48120.764 103744.190 132296.624 116983.772  74808.050                                                       
7   24902.658 159035.150 192322.165 176960.108 134833.591  60107.294                                            
8  181537.534 306251.557 350370.037 334891.070 292890.601 218183.956 158109.867                                 
9  109604.300 234418.188 278474.299 263057.701 220985.725 146250.721  86176.632  71975.579                      
10 194376.196  65190.802  27852.506  36232.387  81947.535 153131.169 213156.710 371115.789 299282.420           
11 164322.125  49433.163   8640.609  20453.063  52778.170 127541.756 187567.297 345624.307 273719.431  36465.060

## view the fst_dist.matrix to be sure the matrices are of equal dimensions
fst_dist.matrix

         RMT      NTP      RBM      BBF      BBM      PKM      GFM      HRM      STM       TG
NTP 0.159692                                                                                 
RBM 0.188168 0.163435                                                                        
BBF 0.217554 0.186786 0.201946                                                               
BBM 0.204693 0.199245 0.199665 0.269264                                                      
PKM 0.188320 0.190819 0.200679 0.221336 0.224671                                             
GFM 0.184286 0.202729 0.199113 0.228546 0.225393 0.168522                                    
HRM 0.262285 0.261783 0.281811 0.361705 0.349507 0.278485 0.273071                           
STM 0.306999 0.304027 0.294816 0.371751 0.496730 0.289160 0.323301 0.353702                  
TG  0.232321 0.214406 0.213610 0.281507 0.284487 0.253728 0.259669 0.368023 0.484215         
SCM 0.200707 0.150778 0.189411 0.230222 0.273689 0.211033 0.205768 0.300398 0.300157 0.285616




# Compute Mantel test for each fst distance matrix
mantel_topo_vs_Fst1 <- mantel.randtest(fst_dist_matrix1, topoDist_dist, nrepet = 9999)
mantel_topo_vs_Fst2 <- mantel.randtest(fst_dist_matrix2, topoDist_dist, nrepet = 9999)
mantel_topo_vs_Fst3 <- mantel.randtest(fst_dist_matrix3, topoDist_dist, nrepet = 9999)
mantel_topo_vs_Fst4 <- mantel.randtest(fst_dist_matrix4, topoDist_dist, nrepet = 9999)

mantel_topo_vs_Fst1
Monte-Carlo test
Call: mantel.randtest(m1 = fst_dist_matrix1, m2 = topoDist_dist, nrepet = 9999)

Observation: 0.560289 

Based on 9999 replicates
Simulated p-value: 0.0042 
Alternative hypothesis: greater 

     Std.Obs  Expectation     Variance 
2.8814691113 0.0002443484 0.0377761237 
mantel_topo_vs_Fst2
Monte-Carlo test
Call: mantel.randtest(m1 = fst_dist_matrix2, m2 = topoDist_dist, nrepet = 9999)

Observation: 0.6461971 

Based on 9999 replicates
Simulated p-value: 2e-04 
Alternative hypothesis: greater 

    Std.Obs Expectation    Variance 
3.209783911 0.002177986 0.040257424 
mantel_topo_vs_Fst3
Monte-Carlo test
Call: mantel.randtest(m1 = fst_dist_matrix3, m2 = topoDist_dist, nrepet = 9999)

Observation: 0.642917 

Based on 9999 replicates
Simulated p-value: 1e-04 
Alternative hypothesis: greater 

      Std.Obs   Expectation      Variance 
 3.2674376470 -0.0006808381  0.0387984604 
mantel_topo_vs_Fst4
Monte-Carlo test
Call: mantel.randtest(m1 = fst_dist_matrix4, m2 = topoDist_dist, nrepet = 9999)

Observation: 0.6394707 

Based on 9999 replicates
Simulated p-value: 1e-04 
Alternative hypothesis: greater 

     Std.Obs  Expectation     Variance 
 3.250479668 -0.002282441  0.038979938 


## final FST vs Topography Matel Test Results table

FST_File                                    Observation    Simulated_p_value
--------------------------------------------------------------
msl8_70md_micpet-071921.p.fst_summary.tsv    0.01387135     0.4046
msl29_49md_micpet-071921.p.fst_summary.tsv   0.06026285     0.193
msl35_45md_micpet-071921.p.fst_summary.tsv   0.05771401     0.2075
msl57_40md_micpet-071921.p.fst_summary.tsv   0.04956768     0.2363




#######################
#
####----- All Mantel test tables
#
#######################





Fst vs Distance (site location) Mantel Test Results
--------------------------------------------------------------
FST File Name                                Observation   P-Value
----------------------------------------------------------------
msl8_70md_micpet-071921.p.fst_summary.tsv     0.5494373    0.0031
msl29_49md_micpet-071921.p.fst_summary.tsv    0.6324467    2e-04
msl35_45md_micpet-071921.p.fst_summary.tsv    0.6286648    2e-04
msl57_40md_micpet-071921.p.fst_summary.tsv    0.6272232    2e-04

FST vs Elevation Mantel Test Results
--------------------------------------------------------------
FST File Name                                Observation   Simulated p-value
--------------------------------------------------------------------------
msl8_70md_micpet-071921.p.fst_summary.tsv    0.01387135        0.4046
msl29_49md_micpet-071921.p.fst_summary.tsv   0.06026285        0.193
msl35_45md_micpet-071921.p.fst_summary.tsv   0.05771401        0.2075
msl57_40md_micpet-071921.p.fst_summary.tsv   0.04956768        0.2363

FST vs Topography Mantel Test Results
-----------------------------------------------------------------------------------
FST File Name                                Observation    Simulated_p-value   Std.Obs    Expectation      Variance
--------------------------------------------------------------------------------------------------------------
mantel_topo_vs_Fst1                        0.560289        0.0042             2.8814691113  0.0002443484   0.0377761237
mantel_topo_vs_Fst2                        0.6461971       2e-04              3.209783911   0.002177986    0.040257424
mantel_topo_vs_Fst3                        0.642917        1e-04              3.2674376470 -0.0006808381   0.0387984604
mantel_topo_vs_Fst4                        0.6394707       1e-04              3.250479668  -0.002282441    0.038979938


# Interpretation:

# Fst vs Distance (site location) Mantel Test:
# The significant positive correlations between Fst and distance suggest the presence of isolation by distance (IBD) in the population. This indicates that genetic differentiation increases as individuals are geographically further apart. The observed correlations imply that gene flow is limited, and genetic drift or other local factors play a role in shaping the genetic structure of the population.

# FST vs Elevation Mantel Test:
# The non-significant correlations between Fst and elevation suggest that genetic differentiation is not strongly influenced by differences in elevation. This implies that elevation is not a major driver of gene flow or genetic divergence in this population. Other factors, such as ecological or selective pressures, may have a stronger impact on genetic variation and adaptation.

# FST vs Topography Mantel Test:
# The significant positive correlations between Fst and topography indicate that genetic differentiation is associated with topographic features. This suggests that the landscape's physical characteristics, such as mountains, valleys, or rivers, may act as barriers to gene flow and contribute to genetic divergence. These topographic barriers could restrict movement and lead to localized adaptation and selection in response to local environmental conditions.



